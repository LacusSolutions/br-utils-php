name: Sync Packages to Individual Repositories

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  detect-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.list-packages.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Detect Packages to Sync
        id: list-packages
        run: |
          PACKAGES_DIR="packages"
          echo "ğŸ” Discovering packages in $PACKAGES_DIR directory..."
          PACKAGES_NAMES=$(find "$PACKAGES_DIR" -mindepth 1 -maxdepth 1 -type d -not -empty | sed 's|^.*/||' | sort)

          PACKAGES=()
          for package_name in $PACKAGES_NAMES; do
            # Skip if package_name is empty or contains invalid characters
            if [[ -z "$package_name" || "$package_name" =~ [^a-zA-Z0-9_-] ]]; then
              echo "âš ï¸  Skipping invalid package name: '$package_name'"
              continue
            fi

            package_prefix="$PACKAGES_DIR/$package_name"
            repo_url="https://github.com/LacusSolutions/br-utils-php_$package_name.git"
            branch="main"
            PACKAGES+=("{\"name\":\"$package_name\",\"prefix\":\"$package_prefix\",\"repo\":\"$repo_url\",\"branch\":\"$branch\"}")
          done

          # Convert array to JSON and save metadata to matrix output
          if [ ${#PACKAGES[@]} -eq 0 ]; then
            echo "âŒ No valid packages found"
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 1
          fi

          printf -v packages_json '%s,' "${PACKAGES[@]}"
          packages_json="[${packages_json%,}]"
          echo "matrix={\"include\":$packages_json}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ${#PACKAGES[@]} packages found"

  sync-package:
    needs: detect-packages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    strategy:
      matrix: ${{ fromJson(needs.detect-packages.outputs.matrix) }}
      fail-fast: false # Continue syncing other packages even if one fails
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Sync Package "${{ matrix.name }}"
        run: |
          echo "ğŸ”„ Syncing '${{ matrix.name }}'..."
          echo "ğŸ“¦ Package:    ${{ matrix.name }}"
          echo "ğŸ“ Path:       ${{ matrix.prefix }}"
          echo "ğŸ”— Repository: ${{ matrix.repo }}"
          echo "ğŸŒ¿ Branch:     ${{ matrix.branch }}"

          if git subtree push --prefix="${{ matrix.prefix }}" "${{ matrix.repo }}" "${{ matrix.branch }}"; then
            echo "âœ… Successfully synced '${{ matrix.name }}'"
          else
            echo "âŒ Failed to sync '${{ matrix.name }}'"
            exit 1
          fi
