name: Sync Packages to Individual Repositories

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  detect-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.list-packages.outputs.matrix }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - id: list-packages
        run: |
          PACKAGES_DIR="packages"
          echo "üîç Discovering packages in $PACKAGES_DIR directory..."
          PACKAGES_NAMES=$(find "$PACKAGES_DIR" -mindepth 1 -maxdepth 1 -type d -not -empty | sed 's|^.*/||' | sort)

          PACKAGES=()
          for package_name in $PACKAGES_NAMES; do
            # Skip if package_name is empty or contains invalid characters
            if [[ -z "$package_name" || "$package_name" =~ [^a-zA-Z0-9_-] ]]; then
              echo "‚ö†Ô∏è  Skipping invalid package name: '$package_name'"
              continue
            fi

            # Subtree on another branch
            package_prefix="$PACKAGES_DIR/$package_name"
            target_type="branch"
            repo_url="git@github.com:LacusSolutions/br-utils-php.git"
            branch="$package_name/main"
            PACKAGES+=("{\"name\":\"$package_name\",\"prefix\":\"$package_prefix\",\"repo\":\"$repo_url\",\"branch\":\"$branch\",\"type\":\"$target_type\"}")

            # Subtree on another repository
            package_prefix="$PACKAGES_DIR/$package_name"
            target_type="repository"
            repo_url="git@github.com:LacusSolutions/br-utils-php_$package_name.git"
            branch="main"
            PACKAGES+=("{\"name\":\"$package_name\",\"prefix\":\"$package_prefix\",\"repo\":\"$repo_url\",\"branch\":\"$branch\",\"type\":\"$target_type\"}")
          done

          # Convert array to JSON and save metadata to matrix output
          if [ ${#PACKAGES[@]} -eq 0 ]; then
            echo "‚ùå No valid packages found"
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 1
          fi

          printf -v packages_json '%s,' "${PACKAGES[@]}"
          packages_json="[${packages_json%,}]"
          echo "matrix={\"include\":$packages_json}" >> $GITHUB_OUTPUT
          echo "üì¶ ${#PACKAGES[@]} packages found"

  sync-package:
    needs: detect-packages
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-packages.outputs.matrix) }}
      fail-fast: false # Continue syncing other packages even if one fails
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - id: push-subtree
        run: |
          echo "üîÑ Syncing '${{ matrix.name }}'..."
          echo "üì¶ Package:    ${{ matrix.name }}"
          echo "üìÅ Path:       ${{ matrix.prefix }}"
          echo "üîó Repository: ${{ matrix.repo }}"
          echo "üåø Branch:     ${{ matrix.branch }}"

          push_output=$(git subtree push --prefix="${{ matrix.prefix }}" "${{ matrix.repo }}" "${{ matrix.branch }}" 2>&1)
          push_exit_code=$?

          if [ $push_exit_code -eq 0 ]; then
            if echo "$push_output" | grep -q "Everything up-to-date"; then
              echo "‚ÑπÔ∏è '${{ matrix.name }}' already up-to-date with ${{ matrix.type }}"
              status="‚ÑπÔ∏è up-to-date"
            else
              echo "‚úÖ '${{ matrix.name }}' successfully synced with ${{ matrix.type }}"
              status="‚úÖ synced"
            fi
          else
            echo "‚ùå '${{ matrix.name }}' failed to sync with ${{ matrix.type }}"
            status="‚ùå failed"
            exit 1
          fi
