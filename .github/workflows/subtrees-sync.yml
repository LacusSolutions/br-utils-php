name: Sync Packages to Individual Repositories

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  detect-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.list-packages.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Detect Packages to Sync
        id: list-packages
        run: |
          PACKAGES_DIR="packages"
          echo "ğŸ” Discovering packages in $PACKAGES_DIR directory..."
          PACKAGES_NAMES=$(find "$PACKAGES_DIR" -mindepth 1 -maxdepth 1 -type d -not -empty | sed 's|^.*/||' | sort)

          PACKAGES=()
          for package_name in $PACKAGES_NAMES; do
            # Skip if package_name is empty or contains invalid characters
            if [[ -z "$package_name" || "$package_name" =~ [^a-zA-Z0-9_-] ]]; then
              echo "âš ï¸  Skipping invalid package name: '$package_name'"
              continue
            fi

            # Subtree on another branch
            package_prefix="$PACKAGES_DIR/$package_name"
            target_type="branch"
            repo_url="git@github.com:LacusSolutions/br-utils-php.git"
            branch="$package_name/main"
            PACKAGES+=("{\"name\":\"$package_name\",\"prefix\":\"$package_prefix\",\"repo\":\"$repo_url\",\"branch\":\"$branch\",\"type\":\"$target_type\"}")

            # Subtree on another repository
            package_prefix="$PACKAGES_DIR/$package_name"
            target_type="repository"
            repo_url="git@github.com:LacusSolutions/br-utils-php_$package_name.git"
            branch="main"
            PACKAGES+=("{\"name\":\"$package_name\",\"prefix\":\"$package_prefix\",\"repo\":\"$repo_url\",\"branch\":\"$branch\",\"type\":\"$target_type\"}")
          done

          # Convert array to JSON and save metadata to matrix output
          if [ ${#PACKAGES[@]} -eq 0 ]; then
            echo "âŒ No valid packages found"
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 1
          fi

          printf -v packages_json '%s,' "${PACKAGES[@]}"
          packages_json="[${packages_json%,}]"
          echo "matrix={\"include\":$packages_json}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ${#PACKAGES[@]} packages found"

  sync-package:
    needs: detect-packages
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-packages.outputs.matrix) }}
      fail-fast: false # Continue syncing other packages even if one fails
    steps:
      - name: Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Add Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Push Subtree "${{ matrix.name }}" (${{ matrix.type }})
        run: |
          echo "ğŸ”„ Syncing '${{ matrix.name }}'..."
          echo "ğŸ“¦ Package:    ${{ matrix.name }}"
          echo "ğŸ“ Path:       ${{ matrix.prefix }}"
          echo "ğŸ”— Repository: ${{ matrix.repo }}"
          echo "ğŸŒ¿ Branch:     ${{ matrix.branch }}"

          if git subtree push --prefix="${{ matrix.prefix }}" "${{ matrix.repo }}" "${{ matrix.branch }}"; then
            echo "âœ… Successfully synced '${{ matrix.name }}'"
          else
            echo "âŒ Failed to sync '${{ matrix.name }}'"
            exit 1
          fi
